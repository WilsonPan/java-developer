clusterRoleRules:
  - apiGroups: [coordination.k8s.io]
    resources: [leases]
    verbs: ['get', 'create', 'update']
  - apiGroups: [""]
    resources: ["nodes", "nodes/stats", "events", "endpoints", "pods", "services"]
    verbs: ["get", "list", "watch"]

daemonset:
  enabled: true
  volumes:
    - name: varlog
      hostPath:
        path: /var/log
    - name: varlibdockercontainers
      hostPath:
        path: /var/lib/docker/containers
    - name: varlogpods
      hostPath:
        path: /var/log/pods
    - name: varlibcontainers
      hostPath:
        path: /var/lib/containers

  volumeMounts:
    - name: varlog
      mountPath: /var/log
      readOnly: true
    - name: varlibdockercontainers
      mountPath: /var/lib/docker/containers
      readOnly: true
    - name: varlogpods
      mountPath: /var/log/pods
      readOnly: true
    - name: varlibcontainers
      mountPath: /var/lib/containers
      readOnly: true

  env:
    - name: NODE_NAME
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName

filebeatConfig:
  filebeat.yml: |
    filebeat.inputs:
    - type: container
      paths:
        - /var/log/containers/spring-app-*.log
      fields:
        app_id: 'spring-app'
        environment: 'prod'
        log_type: 'application'
      fields_under_root: true
      json.keys_under_root: true
      json.overwrite_keys: true
      json.add_error_key: true
      json.message_key: log
      json.time_key: time
      json.time_format: iso8601

    processors:
      - add_kubernetes_metadata:
          host: ${NODE_NAME}
          matchers:
          - logs_path:
              logs_path: "/var/log/containers/"
      - decode_json_fields:
          fields: ["message"]
          target: ""
          overwrite_keys: true
          when:
            has_fields: ['message']
      - decode_json_fields:
          fields: ["log"]
          target: ""
          overwrite_keys: true
          when:
            has_fields: ['log']

    # 禁用模板设置，使用现有的
    setup.template.enabled: false
    setup.ilm.enabled: false

    output.elasticsearch:
      hosts: ['elasticsearch-master:9200']
      username: "elastic"
      password: "elastic123!"
      index: "filebeat-spring-app-%{+yyyy.MM.dd}"

    logging.level: info