# logstash-values.yaml
replicas: 1

# 资源配置
resources:
  requests:
    cpu: "500m"
    memory: "1Gi"
  limits:
    cpu: "1000m"
    memory: "2Gi"

# 配置文件
logstashConfig:
  logstash.yml: |
    http.host: "0.0.0.0"
    xpack.monitoring.enabled: true
    xpack.monitoring.elasticsearch.hosts: [ "elasticsearch-master.logging.svc.cluster.local:9200" ]
    xpack.monitoring.elasticsearch.username: "elastic"
    xpack.monitoring.elasticsearch.password: "elastic123!"

# Pipeline配置
logstashPipeline:
  logstash.conf: |
    input {
      beats {
        port => 5044
      }
    }
    
    filter {
      # 添加Kubernetes metadata
      if [kubernetes] {
        mutate {
          add_field => {
            "cluster_name" => "%{[kubernetes][cluster]}"
            "namespace" => "%{[kubernetes][namespace]}"
            "pod_name" => "%{[kubernetes][pod][name]}"
            "container_name" => "%{[kubernetes][container][name]}"
          }
        }
      }
      
      # 解析JSON日志
      if [message] =~ /^{.*}$/ {
        json {
          source => "message"
          target => "json_content"
        }
      }
      
      # 日期解析
      date {
        match => [ "timestamp", "ISO8601" ]
        target => "@timestamp"
      }
      
      # 清理字段
      mutate {
        remove_field => [ "tags" ]
      }
    }
    
    output {
      elasticsearch {
        hosts => ["elasticsearch-master.logging.svc.cluster.local:9200"]
        user => "elastic"
        password => "elastic123!"
        index => "logstash-%{+YYYY.MM.dd}"
      }
    }

# 服务配置
service:
  type: ClusterIP
  ports:
  - name: beats
    port: 5044
    protocol: TCP
    targetPort: 5044

# 持久化配置（可选）
persistence:
  enabled: false